# APEX 24.2 Contextual Anchor — AI Code Review Principles

> **Purpose:** This document establishes the guiding development principles that any AI tool (Copilot, ChatGPT, Claude, etc.) **must** follow when generating, reviewing, or refactoring Oracle APEX 24.2 code for this project. It ensures consistent, modern, and supportable output.

---

## Table of Contents

1. [Core Principles](#1-core-principles)
2. [Principle Details](#2-principle-details)
3. [Anti-Patterns to Flag](#3-anti-patterns-to-flag)
4. [Known Legacy Debt in This Codebase](#4-known-legacy-debt-in-this-codebase)
5. [AI Workflow Prompt](#5-ai-workflow-prompt)
6. [Quick-Reference Checklist](#6-quick-reference-checklist)

---

## 1. Core Principles

| # | Principle | Short Rule |
|---|-----------|------------|
| P1 | **Public APIs Only** | Never use `wwv_flow_*` internal packages — use documented `APEX_*` APIs |
| P2 | **Modern CSS Variables** | Avoid `!important`; leverage Universal Theme `--ut-*` and `--a-*` CSS custom properties |
| P3 | **Session Context** | Use `apex_session.create_session` / `apex_session.attach` for headless PL/SQL |
| P4 | **JavaScript Namespace** | Use the `apex.*` namespace exclusively; no raw `$()` jQuery or `htmldb_*` legacy calls |
| P5 | **APEX_AI Integration** | Suggest `APEX_AI.GENERATE` / `APEX_AI.CHAT` for data-driven features where applicable |
| P6 | **CSP Compliance** | No inline `javascript:` URIs, no `eval()`, no inline event handlers; use Dynamic Actions or `apex.actions` |
| P7 | **Template Components** | Prefer Template Component plug-ins over hard-coded HTML for cards, badges, and status indicators |
| P8 | **Bind Variables** | Always use bind variables (`:P1_ITEM`) in SQL — never string concatenation |

---

## 2. Principle Details

### P1 — Public APIs Only

Oracle APEX internal packages (`wwv_flow_imp`, `wwv_flow_id`, `wwv_flow_api` internals) are **unsupported** and may change or disappear between patch sets. All new and refactored code must use the documented public API surface.

| Instead of (Internal) | Use (Public API) |
|----------------------|------------------|
| `wwv_flow_imp.create_app_static_file(...)` | `WWV_FLOW_API.CREATE_APP_STATIC_FILE(...)` or upload via APEX Static Files UI |
| `wwv_flow_imp.remove_app_static_file(...)` | `WWV_FLOW_API.REMOVE_APP_STATIC_FILE(...)` |
| `wwv_flow_id.next_val` | `APEX_UTIL.GET_NEXT_ID` or sequence-based IDs |
| `wwv_flow_imp.import_begin(...)` | APEX export/import CLI (`apex export` / `apex import`) |
| `wwv_flow_imp.component_begin(...)` | Declarative Page Designer or `APEX_EXPORT` / `APEX_APPLICATION_INSTALL` APIs |
| `wwv_flow.g_flow_id` | `APEX_APPLICATION.G_FLOW_ID` or `:APP_ID` bind |
| `wwv_flow.g_instance` | `APEX_APPLICATION.G_INSTANCE` or `:APP_SESSION` |

> **Exception:** APEX-exported SQL files (e.g., `install.sql`, `create_application.sql`) legitimately contain `wwv_flow_imp` calls because they are generated by the APEX export engine. Do **not** manually edit these files. Flag only *hand-authored* code using internals.

**Local Docs:** `apex_24doc/content/aeapi/WWV_FLOW_API.html`, `aeapi/APEX_UTIL.html`

---

### P2 — Modern CSS Variables (No `!important`)

APEX 24.2 Universal Theme exposes hundreds of CSS custom properties. Overriding styles with `!important` creates specificity wars and breaks theme roller changes.

#### Preferred Approach

```css
/* BAD — hard-coded colors with !important */
.t-Region {
  background: #1e3a5f !important;
  color: #ffffff !important;
}

/* GOOD — use UT CSS custom properties */
.t-Region {
  --ut-region-background-color: #1e3a5f;
  --ut-region-text-color: #ffffff;
}

/* GOOD — button styling via variables */
.t-Button--hot {
  --a-button-background-color: var(--ut-palette-primary);
  --a-button-text-color: var(--ut-palette-primary-contrast);
}
```

#### Common Universal Theme CSS Variables

| Variable Pattern | Controls |
|-----------------|----------|
| `--ut-body-*` | Page body background, text color |
| `--ut-region-*` | Region backgrounds, borders, shadows |
| `--ut-header-*` | Page header styling |
| `--ut-palette-*` | Theme color palette (primary, success, danger, warning, info) |
| `--a-button-*` | Button appearance properties |
| `--a-cv-*` | Card view properties |
| `--a-badge-*` | Badge component properties |
| `--a-ig-*` | Interactive Grid component properties |

#### When `!important` Is Acceptable

- Utility classes explicitly designed as overrides (rare)
- Print stylesheets
- Never in component or page-level CSS

**Local Docs:** `apex_24doc/content/htmdb/using-themes-and-theme-styles.html`

---

### P3 — Session Context (`apex_session`)

When executing APEX-aware PL/SQL outside of an active APEX request (DBMS_SCHEDULER jobs, standalone scripts, REST handlers), create a proper session context:

```sql
-- CORRECT: Establish APEX session for headless PL/SQL
BEGIN
    apex_session.create_session(
        p_app_id   => 102,
        p_page_id  => 1,
        p_username  => 'USCIS_SCHEDULER'
    );

    -- Now APEX_* packages work correctly
    uscis_api_pkg.refresh_all_cases;

    apex_session.delete_session;
EXCEPTION
    WHEN OTHERS THEN
        apex_session.delete_session;
        RAISE;
END;
/
```

```sql
-- WRONG: Directly calling APEX-dependent code without session
BEGIN
    -- This will fail with "ORA-20987: APEX session not established"
    uscis_api_pkg.refresh_all_cases;
END;
/
```

Relevant project files: `packages/07_uscis_scheduler_pkg.sql` (scheduler jobs should use `apex_session`).

**Local Docs:** `apex_24doc/content/aeapi/APEX_SESSION.html`

---

### P4 — JavaScript `apex.*` Namespace

All client-side code must use the official `apex.*` API. Legacy `htmldb_*` functions and raw jQuery selectors bypass APEX's item and event framework.

| Instead of (Legacy) | Use (Modern) |
|---------------------|-------------|
| `$v('P1_ITEM')` | `apex.item('P1_ITEM').getValue()` |
| `$s('P1_ITEM', val)` | `apex.item('P1_ITEM').setValue(val)` |
| `$('#P1_ITEM').trigger('change')` | `apex.item('P1_ITEM').setValue(val, null, true)` (3rd param=suppress change) or Dynamic Action |
| `htmldb_Get(...)` | `apex.server.process(...)` |
| `$(selector).click(fn)` | Dynamic Action → Execute JavaScript Code, or `apex.actions.add(...)` |
| `$('#region_id').trigger('apexrefresh')` | `apex.region('region_id').refresh()` |
| `apex.submit('REQUEST')` | `apex.page.submit({ request: 'REQUEST', showWait: true })` |
| `alert('msg')` | `apex.message.alert('msg')` |
| `confirm('msg')` | `apex.message.confirm('msg', callback)` |

#### AJAX Pattern

```javascript
// CORRECT: Modern APEX server call
apex.server.process("REFRESH_CASE_STATUS", {
    x01: apex.item("P22_RECEIPT_NUMBER").getValue()
}, {
    success: function(data) {
        apex.message.showPageSuccess("Status refreshed");
        apex.region("case_report").refresh();
    },
    error: function(jqXHR, textStatus, errorThrown) {
        apex.message.showErrors([{
            type: "error",
            location: "page",
            message: "Failed to refresh: " + errorThrown
        }]);
    }
});
```

**Local Docs:** `apex_24doc/content/aexjs/`

---

### P5 — APEX_AI Integration

For data summarization, natural language queries, or content generation features, suggest using the built-in APEX 24.2 Generative AI framework:

```sql
-- Generate a case status summary
DECLARE
    l_summary CLOB;
BEGIN
    l_summary := APEX_AI.GENERATE(
        p_prompt        => 'Summarize the status history for case ' || :P3_RECEIPT_NUMBER,
        p_ai_provider   => 'OCI_GEN_AI',  -- or configured provider
        p_temperature   => 0.3
    );
    :P3_AI_SUMMARY := l_summary;
END;
```

- Configure AI Services in **Shared Components > AI Services**
- Use `APEX_AI.CHAT` for conversational interfaces
- Use `APEX_AI.GET_VECTOR_EMBEDDINGS` for semantic search

**Local Docs:** `apex_24doc/content/aeapi/APEX_AI.html`, `htmdb/including-generative-ai-in-applications.html`

---

### P6 — Content Security Policy (CSP) Compliance

APEX 24.2 enforces CSP headers by default. All code must be CSP-compatible:

| Violation | Fix |
|-----------|-----|
| `<a href="javascript:void(0)">` | `<a href="#" class="js-action">` + Dynamic Action |
| `onclick="doSomething()"` | Dynamic Action or `apex.actions.add(...)` |
| `eval('code')` | Refactor to direct function calls |
| `new Function('return ' + str)` | `JSON.parse(str)` for data |
| Inline `<style>` blocks | Move to page CSS → Inline CSS property or static file |
| `document.write(...)` | DOM manipulation via `apex.util.htmlBuilder()` |

**APEX Setting:** Application Properties → Security → Browser Security → HTTP Headers → Content-Security-Policy

**Local Docs:** `apex_24doc/content/htmdb/understanding-content-security-policy.html`

---

### P7 — Template Components

APEX 24.2 Template Components replace hard-coded HTML for reusable UI patterns. Use them for:

- **Status badges** — Instead of inline `<span class="status-approved">Approved</span>`, create a Template Component with status-to-color mapping
- **Case cards** — Use Card regions with Template Directives (`{if STATUS_CATEGORY = 'APPROVED'/}...{endif/}`)
- **Info tiles** — Dashboard metrics via Template Component plug-ins

```sql
-- Template Directive example in a Cards region
{case STATUS_CATEGORY/}
{when APPROVED/}
  <span class="u-color-success">#STATUS_TEXT#</span>
{when DENIED/}
  <span class="u-color-danger">#STATUS_TEXT#</span>
{when PENDING/}
  <span class="u-color-warning">#STATUS_TEXT#</span>
{otherwise/}
  <span class="u-color-neutral">#STATUS_TEXT#</span>
{endcase/}
```

**Local Docs:** `apex_24doc/content/htmdb/using-template-directives.html`, `htmdb/managing-template-component-plug-ins.html`

---

### P8 — Bind Variables & SQL Injection Prevention

```sql
-- BAD: String concatenation (SQL injection risk)
l_sql := 'SELECT * FROM case_history WHERE receipt_number = ''' || p_receipt || '''';

-- GOOD: Bind variable
l_sql := 'SELECT * FROM case_history WHERE receipt_number = :receipt';
EXECUTE IMMEDIATE l_sql USING p_receipt;

-- BEST: Static SQL with bind
SELECT * INTO l_rec FROM case_history WHERE receipt_number = p_receipt;
```

For dynamic SQL in APEX contexts, use `APEX_EXEC.OPEN_QUERY_CONTEXT` with bind parameters:

```sql
DECLARE
    l_context APEX_EXEC.T_CONTEXT;
BEGIN
    l_context := APEX_EXEC.OPEN_QUERY_CONTEXT(
        p_location          => APEX_EXEC.C_LOCATION_LOCAL_DB,
        p_sql_query         => 'SELECT * FROM case_history WHERE user_id = :user',
        p_sql_parameters    => APEX_EXEC.T_PARAMETERS(
            1 => APEX_EXEC.T_PARAMETER(p_name => 'user', p_value => :APP_USER)
        )
    );
    -- process results
    APEX_EXEC.CLOSE(l_context);
END;
```

**Local Docs:** `apex_24doc/content/aeapi/APEX_EXEC.html`

---

## 3. Anti-Patterns to Flag

When reviewing code, flag these patterns with severity:

| Severity | Pattern | Rule |
|----------|---------|------|
| **CRITICAL** | `wwv_flow_imp.*` in hand-authored code | P1 |
| **CRITICAL** | String-concatenated SQL with user input | P8 |
| **CRITICAL** | `eval()`, `new Function()`, `javascript:` URIs | P6 |
| **HIGH** | `!important` in page/component CSS | P2 |
| **HIGH** | `$v()`, `$s()`, `htmldb_Get` | P4 |
| **HIGH** | APEX PL/SQL called without session context from scheduler | P3 |
| **MEDIUM** | Hard-coded HTML for status badges/cards | P7 |
| **MEDIUM** | Raw jQuery `$('#id')` instead of `apex.item/region` | P4 |
| **LOW** | Missing `showWait: true` on `apex.page.submit()` | P4 |
| **LOW** | Not suggesting APEX_AI for data summaries | P5 |

---

## 4. Known Legacy Debt in This Codebase

The following files contain known internal API usage that originated from APEX export tooling or early development. These are tracked for future remediation:

### `wwv_flow_imp` Usage (Internal API) — **REMEDIATED**

All hand-authored files have been refactored to use the public `WWV_FLOW_API` surface:

| File | Status | Change |
|------|--------|--------|
| `scripts/upload_inline.sql` | ✅ Fixed | `wwv_flow_imp.*` → `wwv_flow_api.*`, `wwv_flow_id.next_val` → `apex_util.get_next_id` |
| `scripts/upload_enhanced_files.sql` | ✅ Fixed | Same refactoring |
| `scripts/upload_static_files.sql` | ✅ Fixed | Same refactoring |
| `scripts/upload-static-files.sh` | ✅ Fixed | Same refactoring (shell-embedded SQL) |
| `Makefile` | ✅ Fixed | `wwv_flow_imp.remove_app_static_file` → `wwv_flow_api.remove_app_static_file` |

### CSS `!important` Overuse — **REMEDIATED**

All hand-authored CSS has been refactored to use `--ut-*` / `--a-*` CSS custom properties per P2:

| File | Status | Change |
|------|--------|--------|
| `scripts/upload_inline.sql` (embedded CSS) | ✅ Fixed | 60+ `!important` declarations → `--ut-*` / `--a-*` CSS variables and cascade-order overrides |
| `scripts/upload-static-files.sh` (embedded CSS) | ✅ Fixed | Same refactoring |
| `scripts/upload_enhanced_files.sql` (embedded CSS) | ✅ Fixed | 115 `!important` declarations → `--ut-*` / `--a-*` CSS variables; 10 retained in utility/accessibility classes (acceptable per P2) |
| `APEX_SETUP_GUIDE.md` (doc examples) | ✅ Fixed | CSS examples updated to model correct UT variable patterns |
| `APEX_FRONTEND_DESIGN.md` (doc examples) | ✅ Fixed | `--a-ig-row-hover-background-color`, `--a-cv-columns` used in place of `!important` |

> **Note:** Print stylesheet `!important` in `APEX_FRONTEND_DESIGN.md` is retained (acceptable per P2).
> **Note:** Utility class `!important` (`.hide-mobile`, `.hide-desktop`, `.stack-mobile`) and accessibility overrides (`prefers-reduced-motion`, `prefers-contrast`) in all CSS files are retained (acceptable per P2).

### APEX-Generated Files (Acceptable — Do Not Modify)

| File | Note |
|------|------|
| `set_environment.sql` | APEX export artifact |
| `user_interfaces.sql` | APEX export artifact |
| `apex/f102/application/**` | All APEX export artifacts |

---

## 5. AI Workflow Prompt

Use this prompt when submitting code to an AI tool for analysis:

---

> **System Prompt for APEX 24.2 Code Review:**
>
> You are an **Oracle APEX 24.2 Architect**. Review the following code against the USCIS Case Tracker Contextual Anchor principles. For each finding:
>
> 1. **Identify legacy patterns** — Flag any `wwv_flow_*` internal APIs, `!important` CSS, `$v()`/`$s()` legacy JS, inline event handlers, or missing session context.
>
> 2. **Propose modern enhancements** — Suggest the specific APEX 24.2 public API, CSS variable, Template Component, or `apex.*` method that replaces the legacy pattern.
>
> 3. **Provide refactored code** — For CRITICAL and HIGH severity findings, output the corrected code block.
>
> 4. **Check CSP compliance** — Ensure no inline JavaScript URIs, `eval()`, or `document.write()`.
>
> 5. **Suggest APEX_AI** — Where applicable, recommend `APEX_AI.GENERATE` or `APEX_AI.CHAT` for data features.
>
> **Principles reference:** APEX_CONTEXTUAL_ANCHOR.md §1-§2
>
> **Code to review:**
> ```sql
> -- paste code here
> ```

---

### Example Prompt for Specific File Review

> Review `scripts/upload_inline.sql` as an APEX 24.2 Architect. Focus on:
> - Replace all `wwv_flow_imp` calls with `WWV_FLOW_API` equivalents
> - Eliminate `!important` from embedded CSS by mapping to `--ut-*` variables
> - Ensure the upload procedure establishes `apex_session` context
>
> Output: Refactored SQL with inline comments explaining each change.

---

## 6. Quick-Reference Checklist

Use this before committing any APEX-related code:

```
[ ] No wwv_flow_imp / wwv_flow_id in hand-written code       (P1)
[ ] No !important in CSS — uses --ut-* / --a-* variables      (P2)
[ ] Headless PL/SQL uses apex_session.create_session           (P3)
[ ] JavaScript uses apex.* namespace exclusively               (P4)
[ ] Data features consider APEX_AI integration                 (P5)
[ ] No inline JS handlers — CSP compliant                     (P6)
[ ] Status/card UI uses Template Components                   (P7)
[ ] All SQL uses bind variables                               (P8)
[ ] APEX-exported files left unmodified                       (exception)
```

---

## References

- **APEX 24.2 PL/SQL API:** `apex_24doc/content/aeapi/`
- **APEX 24.2 JS API:** `apex_24doc/content/aexjs/`
- **Universal Theme CSS Variables:** Application → Theme Roller → Custom CSS (inspect available `--ut-*` properties)
- **CSP Documentation:** `apex_24doc/content/htmdb/understanding-content-security-policy.html`
- **Template Components:** `apex_24doc/content/htmdb/managing-template-component-plug-ins.html`
- **APEX_AI:** `apex_24doc/content/aeapi/APEX_AI.html`
- **APEX_SESSION:** `apex_24doc/content/aeapi/APEX_SESSION.html`
