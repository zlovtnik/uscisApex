# =============================================================================
# USCIS Case Tracker — Nginx HTTPS Configuration (SSL/TLS termination)
# =============================================================================
# Use this instead of default.conf when you want Nginx to terminate TLS.
# Mount your certs into the container or use Certbot sidecar.
#
# To enable:
#   1. Rename this file to default.conf.template
#   2. Mount certs at /etc/nginx/ssl/
#   3. Expose port 443 in docker-compose.yml
# =============================================================================

upstream ords_backend {
    server ${ORDS_HOST}:${ORDS_PORT};
    keepalive 32;
}

# ---- Map scheme for HTTPS upstream (e.g., Oracle Autonomous DB Cloud) ----
# When ORDS_SCHEME=https, nginx uses TLS to connect to the upstream.

limit_req_zone $binary_remote_addr zone=apex_limit:10m rate=30r/s;

# ---- Proxy cache zone for APEX static assets ----
proxy_cache_path /var/cache/nginx/apex_static levels=1:2
                 keys_zone=apex_cache:10m max_size=256m inactive=7d
                 use_temp_path=off;

# Redirect HTTP → HTTPS
server {
    listen 80;
    server_name ${PUBLIC_DOMAIN};
    return 301 https://$host$request_uri;
}

server {
    listen       443 ssl;
    http2        on;
    server_name  ${PUBLIC_DOMAIN};

    # --- TLS Certificates ---------------------------------------------------
    ssl_certificate     /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # --- TLS hardening ------------------------------------------------------
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5:!RC4;
    ssl_prefer_server_ciphers on;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;

    # HSTS (uncomment once you're confident TLS is stable)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # --- Security headers ---------------------------------------------------
    add_header X-Frame-Options        "SAMEORIGIN"       always;
    add_header X-Content-Type-Options "nosniff"          always;
    add_header Referrer-Policy        "strict-origin-when-cross-origin" always;
    # X-XSS-Protection omitted — deprecated and potentially harmful
    # See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection

    # --- Buffers & timeouts -------------------------------------------------
    proxy_buffer_size       128k;
    proxy_buffers           4 256k;
    proxy_busy_buffers_size 256k;
    proxy_connect_timeout   60s;
    proxy_read_timeout      300s;
    proxy_send_timeout      60s;

    # --- Routes (identical to HTTP version) ---------------------------------

    location = / {
        return 301 ${PUBLIC_PATH}/;
    }

    location ${PUBLIC_PATH}/ {
        limit_req zone=apex_limit burst=60 nodelay;

        proxy_pass ${ORDS_SCHEME}://ords_backend/ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/;

        # --- SSL proxy settings (active only when ORDS_SCHEME=https) ---------
        proxy_ssl_server_name on;
        proxy_ssl_name        ${ORDS_HOST};

        proxy_redirect ${ORDS_SCHEME}://${ORDS_HOST}/ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/ https://$host${PUBLIC_PATH}/;
        proxy_redirect /ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/                              ${PUBLIC_PATH}/;

        proxy_cookie_domain ${ORDS_HOST} $host;
        proxy_cookie_path /ords/ ${PUBLIC_PATH}/;

        # Host MUST be the backend hostname — Oracle ADB rejects unknown hosts
        proxy_set_header Host              ${ORDS_HOST};
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header X-Forwarded-Port  $server_port;
        proxy_set_header Origin            "";

        sub_filter '${ORDS_SCHEME}://${ORDS_HOST}/ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/' 'https://$host${PUBLIC_PATH}/';
        sub_filter '/ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/'                              '${PUBLIC_PATH}/';
        sub_filter_once off;
        sub_filter_types text/html text/css application/javascript application/json;

        proxy_http_version 1.1;
        proxy_set_header   Connection "";
    }

    # ---- ORDS passthrough — APEX engine, app static files, wwv_flow.* -------
    location /ords/ {
        proxy_pass ${ORDS_SCHEME}://ords_backend/ords/;

        proxy_ssl_server_name on;
        proxy_ssl_name        ${ORDS_HOST};

        proxy_set_header Host              ${ORDS_HOST};
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header Origin            "";   # Strip Origin — prevents ORDS CORS rejection

        proxy_cookie_domain ${ORDS_HOST} $host;

        proxy_http_version 1.1;
        proxy_set_header   Connection "";
    }

    location /i/ {
        proxy_pass ${ORDS_SCHEME}://ords_backend/i/;

        proxy_ssl_server_name on;
        proxy_ssl_name        ${ORDS_HOST};

        proxy_set_header Host              ${ORDS_HOST};
        proxy_set_header X-Forwarded-Proto $scheme;

        # Enable proxy cache for static assets
        proxy_cache apex_cache;
        proxy_cache_valid 200 1d;
        expires 7d;
        add_header Cache-Control "public, immutable" always;

        # Re-declare security headers (add_header in a location block
        # overrides all parent-level add_header directives)
        add_header X-Frame-Options        "SAMEORIGIN"       always;
        add_header X-Content-Type-Options "nosniff"          always;
        add_header Referrer-Policy        "strict-origin-when-cross-origin" always;
    }

    location /api/ {
        proxy_pass ${ORDS_SCHEME}://ords_backend/ords/${ORDS_WORKSPACE}/api/;

        proxy_ssl_server_name on;
        proxy_ssl_name        ${ORDS_HOST};

        proxy_redirect ${ORDS_SCHEME}://${ORDS_HOST}/ords/${ORDS_WORKSPACE}/api/ https://$host/api/;
        proxy_redirect /ords/${ORDS_WORKSPACE}/api/ /api/;

        proxy_set_header Host              ${ORDS_HOST};
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin            "";   # Strip Origin — prevents ORDS CORS rejection
    }

    location /health {
        access_log off;
        default_type application/json;
        return 200 '{"status":"ok"}';
    }

    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
