# =============================================================================
# USCIS Case Tracker — Nginx Reverse Proxy Configuration
# =============================================================================
# Masks the real ORDS/APEX URL (/ords/r/uscis_app/...) behind a clean
# public path (/uscis/).  Handles proxy_pass routing, Location header
# rewriting, cookie path translation, and HTML/JS content rewriting
# via sub_filter so the internal URL is never exposed to the browser.
#
# Environment variables (set via Docker env or .env):
#   ORDS_HOST          — internal ORDS hostname (default: ords)
#   ORDS_PORT          — internal ORDS port     (default: 8080)
#   PUBLIC_DOMAIN      — your public domain      (default: localhost)
#   PUBLIC_PATH        — masked path prefix      (default: /uscis)
#   ORDS_WORKSPACE     — APEX workspace name     (default: uscis_app)
#   APEX_APP_ALIAS     — APEX app alias          (default: uscis-case-tracker)
# =============================================================================

# ---- Upstream: Oracle REST Data Services ----
upstream ords_backend {
    server ${ORDS_HOST}:${ORDS_PORT};
    keepalive 32;
}

# ---- Map scheme for HTTPS upstream (e.g., Oracle Autonomous DB Cloud) ----
# When ORDS_SCHEME=https, nginx uses TLS to connect to the upstream.
# Set via env var; defaults to http for local Docker-to-Docker networking.

# ---- Resolve real client scheme (Render terminates TLS → nginx sees HTTP) --
# X-Forwarded-Proto from Render/LB tells us the actual client-facing scheme.
map $http_x_forwarded_proto $client_scheme {
    default $scheme;
    https   https;
    http    http;
}

# ---- Rate limiting zone (optional, mirrors API_RATE_LIMITER table) ----
limit_req_zone $binary_remote_addr zone=apex_limit:10m rate=30r/s;

# ---- Proxy cache zone for APEX static assets ----
proxy_cache_path /var/cache/nginx/apex_static levels=1:2
                 keys_zone=apex_cache:10m max_size=256m inactive=7d
                 use_temp_path=off;

server {
    listen       80 default_server;
    server_name  ${PUBLIC_DOMAIN} _;

    # --- Security headers ---------------------------------------------------
    add_header X-Frame-Options        "SAMEORIGIN"       always;
    add_header X-Content-Type-Options "nosniff"          always;
    add_header Referrer-Policy        "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    # NOTE: 'unsafe-eval' and 'unsafe-inline' are required by Oracle APEX 24.2
    # runtime (inline event handlers, dynamic eval in widget code).  Replace
    # with nonce-based CSP if a future APEX release supports it.
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';" always;

    # --- Logging ------------------------------------------------------------
    access_log /var/log/nginx/apex_access.log;
    error_log  /var/log/nginx/apex_error.log warn;

    # --- Buffers & timeouts for APEX ----------------------------------------
    proxy_buffer_size       128k;
    proxy_buffers           4 256k;
    proxy_busy_buffers_size 256k;
    proxy_connect_timeout   60s;
    proxy_read_timeout      300s;   # APEX long-running pages / API calls
    proxy_send_timeout      60s;

    # ========================================================================
    # 1. Root redirect — sends visitors straight to the masked app URL
    # ========================================================================
    location = / {
        return 301 ${PUBLIC_PATH}/;
    }

    # ========================================================================
    # 2. Main Application — URL masking
    #    Browser sees:  https://yourdomain.com/uscis/...
    #    ORDS receives: http://ords:8080/ords/r/uscis_app/uscis-case-tracker/...
    # ========================================================================
    location ${PUBLIC_PATH}/ {
        limit_req zone=apex_limit burst=60 nodelay;

        # Trailing slash on proxy_pass is CRITICAL — it strips the location
        # prefix and replaces it with the ORDS path.
        proxy_pass ${ORDS_SCHEME}://ords_backend/ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/;

        # --- SSL proxy settings (active only when ORDS_SCHEME=https) ---------
        proxy_ssl_server_name on;
        proxy_ssl_name        ${ORDS_HOST};

        # --- Rewrite Location headers returned by ORDS ----------------------
        # ONLY rewrite the app navigation path — not blanket /ords/ paths.
        # ORDS engine paths (wwv_flow.*, static files) are handled by /ords/ location.
        proxy_redirect ${ORDS_SCHEME}://${ORDS_HOST}/ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/ $client_scheme://$host${PUBLIC_PATH}/;
        proxy_redirect /ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/                              ${PUBLIC_PATH}/;

        # --- Cookie rewriting ------------------------------------------------
        # Path MUST be / so the cookie covers both /uscis/ and /ords/ routes.
        # If set to /uscis/, the browser won't send it to /ords/wwv_flow.accept.
        proxy_cookie_domain ${ORDS_HOST} $host;
        proxy_cookie_path /ords/ /;

        # --- Standard proxy headers for APEX/ORDS ---------------------------
        # Host MUST be the backend hostname — Oracle ADB rejects unknown hosts
        proxy_set_header Host              ${ORDS_HOST};
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $client_scheme;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header X-Forwarded-Port  $server_port;
        proxy_set_header Origin            "";   # Avoids CORS issues in Chrome

        # --- Content rewriting (hide real URLs in HTML/JS/CSS) --------------
        # ONLY rewrite the app navigation path.  Do NOT blanket-rewrite /ords/
        # because APEX engine paths (wwv_flow.*, r/workspace/appid/files/*)
        # must stay as /ords/... and hit the /ords/ passthrough location.
        sub_filter '${ORDS_SCHEME}://${ORDS_HOST}/ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/' '$client_scheme://$host${PUBLIC_PATH}/';
        sub_filter '/ords/r/${ORDS_WORKSPACE}/${APEX_APP_ALIAS}/'                              '${PUBLIC_PATH}/';
        sub_filter_once off;
        sub_filter_types text/html text/css application/javascript application/json;

        # Enable HTTP/1.1 keepalive / connection reuse for the upstream.
        # NOTE: Disabling buffering (proxy_buffering off) would break sub_filter.
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
    }

    # ========================================================================
    # 3. ORDS passthrough — APEX engine, app static files, wwv_flow.*
    #    These paths must reach the backend as-is at /ords/...
    #    (wwv_flow.js_dialogs, wwv_flow.accept, r/workspace/appid/files/*, etc.)
    # ========================================================================
    location /ords/ {
        proxy_pass ${ORDS_SCHEME}://ords_backend/ords/;

        proxy_ssl_server_name on;
        proxy_ssl_name        ${ORDS_HOST};

        proxy_set_header Host              ${ORDS_HOST};
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $client_scheme;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header Origin            "";   # Strip Origin — prevents ORDS CORS rejection

        proxy_cookie_domain ${ORDS_HOST} $host;
        proxy_cookie_path /ords/ /;

        proxy_http_version 1.1;
        proxy_set_header   Connection "";
    }

    # ========================================================================
    # 4. APEX static resources (/i/ = images, CSS, JS shipped with APEX)
    # ========================================================================
    location /i/ {
        proxy_pass ${ORDS_SCHEME}://ords_backend/i/;

        proxy_ssl_server_name on;
        proxy_ssl_name        ${ORDS_HOST};

        proxy_set_header Host              ${ORDS_HOST};
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Enable HTTP/1.1 keepalive / connection reuse for the upstream
        proxy_http_version 1.1;
        proxy_set_header   Connection "";

        # Enable proxy cache for static assets
        proxy_cache apex_cache;
        proxy_cache_valid 200 1d;
        expires 7d;
        add_header Cache-Control "public, immutable" always;

        # Re-declare security headers (add_header in a location block
        # overrides all parent-level add_header directives)
        add_header X-Frame-Options        "SAMEORIGIN"       always;
        add_header X-Content-Type-Options "nosniff"          always;
        add_header Referrer-Policy        "strict-origin-when-cross-origin" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';" always;
    }

    # ========================================================================
    # 5. ORDS REST APIs (if you expose REST endpoints publicly)
    # ========================================================================
    location /api/ {
        limit_req zone=apex_limit burst=60 nodelay;

        proxy_pass ${ORDS_SCHEME}://ords_backend/ords/${ORDS_WORKSPACE}/api/;

        proxy_ssl_server_name on;
        proxy_ssl_name        ${ORDS_HOST};

        proxy_redirect ${ORDS_SCHEME}://${ORDS_HOST}/ords/${ORDS_WORKSPACE}/api/ $client_scheme://$host/api/;
        proxy_redirect /ords/${ORDS_WORKSPACE}/api/ /api/;

        proxy_set_header Host              ${ORDS_HOST};
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $client_scheme;
        proxy_set_header Origin            "";   # Strip Origin — prevents ORDS CORS rejection

        # Enable HTTP/1.1 keepalive / connection reuse for the upstream
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
    }

    # ========================================================================
    # 6. Health check endpoint (for Docker / load-balancer probes)
    # ========================================================================
    location /health {
        access_log off;
        default_type application/json;
        return 200 '{"status":"ok"}';
    }

    # ========================================================================
    # 7. Deny access to hidden files
    # ========================================================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
